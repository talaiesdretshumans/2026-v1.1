<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="utf-8"/>
<title>Talaies pels drets humans 2026</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-mouse-position@1.0.1/src/L.Control.MousePosition.css" />

<style>
  html, body { height: 100%; margin: 0; background: #000; font-family: Arial, sans-serif; }
  #map { width: 100vw; height: 100vh; }

  .map-title {
    position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
    z-index: 1000; background: #000; color: #fff;
    padding: 8px 16px; border-radius: 8px; font-size: 20px;
    font-weight: bold; border: 1px solid #555;
    font-family: Tahoma, Arial, sans-serif;
  }
  .map-footer {
    position: fixed; bottom: 10px; left: 10px; z-index: 1000;
    background: rgba(0,0,0,0.7); color: #fff; padding: 6px 12px;
    border-radius: 6px; font-size: 12px; border: 1px solid #555;
  }

  .talaia-label span,
  .altres-label span {
    color: #000; font-size: 12px;
    text-shadow: -2px 0 #fff, 0 2px #fff, 2px 0 #fff, 0 -2px #fff,
                 -2px -2px #fff, 2px -2px #fff, -2px 2px #fff, 2px 2px #fff;
    white-space: nowrap;
  }

  .line-label span {
    color: #5099ff; font-size: 12px;
    text-shadow: -2px 0 #fff, 0 2px #fff, 2px 0 #fff, 0 -2px #fff,
                 -2px -2px #fff, 2px -2px #fff, -2px 2px #fff, 2px 2px #fff;
    white-space: nowrap;
  }

  .popup-image {
    max-width: 250px; max-height: 180px;
    display: block; margin-top: 5px;
    border-radius: 4px; border: 1px solid #ccc;
  }

  .control-panel {
    background: rgba(0,0,0,0.85); padding: 0; border-radius: 6px;
    color: #fff; font-size: 13px; border: 1px solid #555;
    box-shadow: 0 0 4px rgba(0,0,0,0.5);
  }
  .control-panel .control-toggle {
    cursor: pointer; padding: 4px 8px; text-align: center;
    border-bottom: 1px solid #444; font-size: 16px;
  }
  .control-panel .control-content {
    display: none; padding: 5px 8px 8px 8px; max-width: 220px;
  }
  .control-panel.open .control-content { display: block; }

  .control-panel button { margin-top: 4px; width: 100%; font-size: 13px; }
  .measure-instructions { font-size: 11px; margin-top: 4px; color: #ddd; }

  .measure-distance-label {
    background: rgba(255,255,255,0.9); padding: 2px 4px;
    border-radius: 4px; border: 1px solid #888; font-size: 11px;
  }

  .altres-square {
    width: 12px;
    height: 12px;
    background: #6bbf59;
    border: 2px solid #3a5f2a;
    box-sizing: border-box;
  }
</style>
</head>
<body>
<div class="map-title">Talaies pels drets humans 2026</div>
<div class="map-footer">Autor: Lloren칞 Guasp, 2025</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet-mouse-position@1.0.1/src/L.Control.MousePosition.js"></script>
<script src="https://unpkg.com/georaster@1.6.1/dist/georaster.browser.min.js"></script>
<script src="https://unpkg.com/georaster-layer-for-leaflet@3.9.0/dist/georaster-layer-for-leaflet.min.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<script>
// MAPA
const map = L.map("map", {
  center: [39.7, 3.0],
  zoom: 9,
  zoomControl: true
});

// BASEMAPS
const cartoLight = L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
  { maxZoom: 19, attribution: '&copy; <a href="https://carto.com/">CARTO</a>' }
).addTo(map);

const cartoDark = L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
  { maxZoom: 19, attribution: '&copy; <a href="https://carto.com/">CARTO</a>' }
);

const osm = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { maxZoom: 19, attribution: "&copy; OpenStreetMap contributors" }
);

const esriWorldImagery = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { maxZoom: 19, attribution: "Tiles &copy; Esri" }
);

const openTopo = L.tileLayer(
  "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
  {
    maxZoom: 17,
    attribution: 'Map data: &copy; OSM, SRTM | Style: &copy; OpenTopoMap'
  }
);

const baseMaps = {
  "CARTO Light": cartoLight,
  "CARTO Dark": cartoDark,
  "OpenStreetMap": osm,
  "Ortofoto Esri": esriWorldImagery,
  "Mapa de relleu (OpenTopoMap)": openTopo
};

// OVERLAYS
let talaiesLayer = L.geoJSON(null);
let altresPuntsLayer = L.geoJSON(null);   // se deja definido pero sin usar
let liniesOverlay = L.featureGroup();
let rasterLayer = null;                   // se deja definido pero sin usar

let liniesData = null;
let lineDistanceLabels = [];
let talaiaLabels = [];
let altresLabels = [];

const layerControl = L.control.layers(baseMaps, {}, { collapsed: false }).addTo(map);

// GEOCODER
L.Control.geocoder({ defaultMarkGeocode: false, collapsed: true })
  .on("markgeocode", function(e) {
    const bbox = e.geocode.bbox;
    const poly = L.polygon([
      [bbox.getSouthEast().lat, bbox.getSouthEast().lng],
      [bbox.getNorthEast().lat, bbox.getNorthEast().lng],
      [bbox.getNorthWest().lat, bbox.getNorthWest().lng],
      [bbox.getSouthWest().lat, bbox.getSouthWest().lng]
    ]);
    map.fitBounds(poly.getBounds());
  })
  .addTo(map);

// MESURA DISTNCIA
let measuring = false;
let measurePoints = [];
let measureLine = null;
let measureLabel = null;

const MeasureControl = L.Control.extend({
  options: { position: "topleft" },
  onAdd: function(map) {
    const container = L.DomUtil.create("div", "leaflet-control control-panel");
    container.innerHTML =
      '<div class="control-toggle" title="Eina de mesura de dist맕cia">游늺</div>' +
      '<div class="control-content">' +
        "<b>Mesura de dist맕cia</b><br>" +
        '<button id="measure-toggle-btn">Activar mesura</button>' +
        '<div class="measure-instructions">' +
          "1) Clic primer punt<br>" +
          "2) Clic segon punt per veure la dist맕cia<br>" +
          "3) Un altre clic comen칞a una nova mesura." +
        "</div>" +
      "</div>";

    const toggle = container.querySelector(".control-toggle");
    const btn = container.querySelector("#measure-toggle-btn");

    L.DomEvent.disableClickPropagation(container);

    toggle.onclick = () => container.classList.toggle("open");

    btn.onclick = (e) => {
      L.DomEvent.stopPropagation(e);
      measuring = !measuring;
      if (measuring) {
        btn.textContent = "Desactivar mesura";
        startMeasuring();
      } else {
        btn.textContent = "Activar mesura";
        stopMeasuring();
      }
    };

    return container;
  }
});
map.addControl(new MeasureControl());

map.on("click", function(e) {
  if (!measuring) return;

  measurePoints.push([e.latlng.lng, e.latlng.lat]);

  if (measurePoints.length === 1) {
    if (measureLine) { map.removeLayer(measureLine); measureLine = null; }
    if (measureLabel) { map.removeLayer(measureLabel); measureLabel = null; }
  }

  if (measurePoints.length === 2) {
    const from = turf.point(measurePoints[0]);
    const to = turf.point(measurePoints[1]);
    const distanceKm = turf.distance(from, to, { units: "kilometers" });
    const distanceM = distanceKm * 1000;

    const lineLatLngs = [
      [measurePoints[0][1], measurePoints[0][0]],
      [measurePoints[1][1], measurePoints[1][0]]
    ];
    if (measureLine) map.removeLayer(measureLine);
    measureLine = L.polyline(lineLatLngs, {
      color: "#ffcc00",
      weight: 3,
      dashArray: "5, 5"
    }).addTo(map);

    const center = [
      (measurePoints[0][1] + measurePoints[1][1]) / 2,
      (measurePoints[0][0] + measurePoints[1][0]) / 2
    ];
    const labelText = distanceM.toFixed(0) + " m";

    if (measureLabel) map.removeLayer(measureLabel);
    measureLabel = L.marker(center, {
      icon: L.divIcon({
        className: "measure-distance-label",
        html: labelText,
        iconSize: [0,0],
        iconAnchor: [0,0]
      })
    }).addTo(map);

    measurePoints = [];
  }
});

function startMeasuring() {
  measurePoints = [];
  if (measureLine) { map.removeLayer(measureLine); measureLine = null; }
  if (measureLabel) { map.removeLayer(measureLabel); measureLabel = null; }
}
function stopMeasuring() {
  measurePoints = [];
  if (measureLine) { map.removeLayer(measureLine); measureLine = null; }
  if (measureLabel) { map.removeLayer(measureLabel); measureLabel = null; }
}

// ETIQUETES
function clearLineDistanceLabels() {
  lineDistanceLabels.forEach(m => map.removeLayer(m));
  lineDistanceLabels = [];
}

function updateLabelsVisibility() {
  const zoom = map.getZoom();
  const show = zoom >= 11;

  talaiaLabels.forEach(m => {
    if (show) {
      if (!map.hasLayer(m)) map.addLayer(m);
    } else {
      if (map.hasLayer(m)) map.removeLayer(m);
    }
  });

  // altresLabels se queda, pero no se generan etiquetas al no cargar altres_punts
  altresLabels.forEach(m => {
    if (show && map.hasLayer(altresPuntsLayer)) {
      if (!map.hasLayer(m)) map.addLayer(m);
    } else {
      if (map.hasLayer(m)) map.removeLayer(m);
    }
  });

  lineDistanceLabels.forEach(m => {
    if (show && map.hasLayer(liniesOverlay)) {
      if (!map.hasLayer(m)) map.addLayer(m);
    } else {
      if (map.hasLayer(m)) map.removeLayer(m);
    }
  });
}

map.on("zoomend", updateLabelsVisibility);
map.on("overlayadd", e => { if (e.layer === liniesOverlay || e.layer === altresPuntsLayer) updateLabelsVisibility(); });
map.on("overlayremove", e => {
  if (e.layer === liniesOverlay) {
    lineDistanceLabels.forEach(m => { if (map.hasLayer(m)) map.removeLayer(m); });
  }
  if (e.layer === altresPuntsLayer) {
    altresLabels.forEach(m => { if (map.hasLayer(m)) map.removeLayer(m); });
  }
});

// FUNCIONS AUXILIARS
function getParticipa(props) {
  const v = props.participacio ?? props.Participacio ?? props.PARTICIPACIO;
  if (v == null) return false;
  return String(v).toLowerCase() === "true";
}

// CARREGAR TALAIES (ADAPTAT AL NOM ACTUAL)
fetch("talaies_251208.geojson")
  .then(r => r.json())
  .then(data => {
    talaiesLayer = L.geoJSON(data, {
      pointToLayer: (feature, latlng) => {
        const props = feature.properties || {};
        const participa = getParticipa(props);

        const fillColor = participa ? "#e6b325" : "#8c8c8c";
        const borderColor = "#7a1f1f";

        const marker = L.circleMarker(latlng, {
          radius: 7,
          color: borderColor,
          weight: 2,
          fillColor: fillColor,
          fillOpacity: 1
        });

        const nom   = props.Nom   || props.nom   || props.NOM   || "Sense nom";
        const tipus = props.Tipus || props.tipus || props.TIPUS || "";
        const estat = props.Estat || props.estat || props.ESTAT || props["Estat de conservaci칩"] || "";
        const img   = props.Imatge|| props.imatge|| props.image || props.Image || null;

        let html = `<b>${nom}</b>`;
        if (tipus) html += `<br><i>${tipus}</i>`;
        if (estat) html += `<br>Estat: ${estat}`;
        if (img)   html += `<br><img class="popup-image" src="${img}" alt="${nom}">`;

        marker.bindPopup(html);

        const label = L.marker(latlng, {
          icon: L.divIcon({
            className: "talaia-label",
            html: `<span>${nom}</span>`,
            iconSize: [0,0],
            iconAnchor: [0,0]
          })
        });
        talaiaLabels.push(label);

        // clic per activar l칤nies associades
        marker.on("click", () => {
          if (!liniesData) return;

          liniesOverlay.clearLayers();
          clearLineDistanceLabels();

          const pointTalaia = turf.point([latlng.lng, latlng.lat]);

          const matching = liniesData.features.filter(feat => {
            if (!feat.geometry) return false;
            try { return turf.booleanPointOnLine(pointTalaia, feat); }
            catch(e){ console.error(e); return false; }
          });

          matching.forEach(feat => {
            const coords = feat.geometry.coordinates.map(c => [c[1], c[0]]);
            const line = L.polyline(coords, {
              color: "#5099ff", weight: 3, opacity: 0.9
            }).addTo(liniesOverlay);

            const distProp =
              feat.properties?.distancia_km ||
              feat.properties?.Distancia_km ||
              feat.properties?.dist_km || null;

            if (distProp != null) {
              try {
                const distText = parseFloat(distProp).toFixed(1) + " km";
                const center = turf.center(feat);
                const [cx, cy] = center.geometry.coordinates;
                const labelMarker = L.marker([cy, cx], {
                  icon: L.divIcon({
                    className: "line-label",
                    html: `<span>${distText}</span>`,
                    iconSize: [0,0],
                    iconAnchor: [0,0]
                  })
                });
                lineDistanceLabels.push(labelMarker);
              } catch(e){ console.error(e); }
            }
          });

          if (!map.hasLayer(liniesOverlay)) liniesOverlay.addTo(map);
          updateLabelsVisibility();
        });

        return marker;
      }
    }).addTo(map);

    layerControl.addOverlay(talaiesLayer, "Talaies, torres i fortificacions");

    map.fitBounds(talaiesLayer.getBounds());
    updateLabelsVisibility();
  });

// *** NO SE CARGA ALTRES_PUNTS_V2 ***

// CARREGAR L칈NIES (se mantiene igual)
fetch("linies_visio_251208.geojson")
  .then(r => r.json())
  .then(data => {
    liniesData = data;
    layerControl.addOverlay(liniesOverlay, "L칤nies de visi칩");
  });

// *** NO SE CARGA EL RASTER contaminacio_luminica_23.tif ***

// LLEGENDA (sin altres punts ni contaminaci칩 lum칤nica)
const legend = L.control({ position: "bottomright" });
legend.onAdd = function(map) {
  const div = L.DomUtil.create("div", "info legend");
  Object.assign(div.style, {
    background: "rgba(0,0,0,0.7)",
    color: "#fff",
    padding: "8px 10px",
    borderRadius: "6px",
    border: "1px solid #555",
    fontSize: "12px"
  });

  div.innerHTML += "<b>Llegenda</b><br>";
  div.innerHTML += '<i style="background:#e6b325;width:10px;height:10px;display:inline-block;margin-right:5px;border-radius:50%;border:2px solid #7a1f1f;"></i>participen (talaies)<br>';
  div.innerHTML += '<i style="background:#8c8c8c;width:10px;height:10px;display:inline-block;margin-right:5px;border-radius:50%;border:2px solid #7a1f1f;"></i>no participen (talaies)<br>';
  div.innerHTML += '<i style="width:16px;height:2px;display:inline-block;margin-right:5px;background:#5099ff;"></i>L칤nies de visi칩<br>';

  return div;
};
legend.addTo(map);
</script>
</body>
</html>
